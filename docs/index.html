<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"smallgress.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="记录学习js的历程">
<meta property="og:type" content="website">
<meta property="og:title" content="一片野草">
<meta property="og:url" content="http://smallgress.github.io/index.html">
<meta property="og:site_name" content="一片野草">
<meta property="og:description" content="记录学习js的历程">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="SmallGress">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://smallgress.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>一片野草</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">一片野草</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录自己的学习路</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2022/05/16/%E7%9D%A1%E7%9C%A0%E5%BB%BA%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/16/%E7%9D%A1%E7%9C%A0%E5%BB%BA%E8%AE%AE/" class="post-title-link" itemprop="url">睡眠建议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-16 22:16:33 / 修改时间：22:24:45" itemprop="dateCreated datePublished" datetime="2022-05-16T22:16:33+08:00">2022-05-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-把Kindle放在床头柜上"><a href="#1-把Kindle放在床头柜上" class="headerlink" title="1. 把Kindle放在床头柜上"></a>1. 把Kindle放在床头柜上</h3><p>避免在睡前玩手机，导致睡前解除到蓝光</p>
<h3 id="2-买一个闹钟"><a href="#2-买一个闹钟" class="headerlink" title="2. 买一个闹钟"></a>2. 买一个闹钟</h3><p>放在离床比较远的地方，这样子时间一到必须起床关闹钟，养成规律的时间</p>
<h3 id="3-下午2点之后不要再摄入咖啡因"><a href="#3-下午2点之后不要再摄入咖啡因" class="headerlink" title="3. 下午2点之后不要再摄入咖啡因"></a>3. 下午2点之后不要再摄入咖啡因</h3><p>咖啡因会在人体停留很久</p>
<h3 id="4-使用遮光窗帘"><a href="#4-使用遮光窗帘" class="headerlink" title="4. 使用遮光窗帘"></a>4. 使用遮光窗帘</h3><p>能很好个改善睡眠</p>
<h3 id="5-最舒适的睡觉温度是19摄氏度"><a href="#5-最舒适的睡觉温度是19摄氏度" class="headerlink" title="5. 最舒适的睡觉温度是19摄氏度"></a>5. 最舒适的睡觉温度是19摄氏度</h3><h3 id="6-将注意力放在自身"><a href="#6-将注意力放在自身" class="headerlink" title="6. 将注意力放在自身"></a>6. 将注意力放在自身</h3><p>4个步骤：</p>
<ol>
<li>闭上眼睛，先放松脸部肌肉</li>
<li>然后放松腿部肌肉，幻想他陷入床垫</li>
<li>再放松手臂，幻想他陷入床垫</li>
<li>放松其他部分，专注吸气和呼气</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2020/09/15/%E9%94%99%E8%AF%AF%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9C%A8%E9%94%99%E8%AF%AF%E7%9A%84%E5%88%86%E6%94%AF%E5%85%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/15/%E9%94%99%E8%AF%AF%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9C%A8%E9%94%99%E8%AF%AF%E7%9A%84%E5%88%86%E6%94%AF%E5%85%A8%E8%A7%A3/" class="post-title-link" itemprop="url">错误的代码在错误的分支全解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-15 23:38:21" itemprop="dateCreated datePublished" datetime="2020-09-15T23:38:21+08:00">2020-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 00:40:34" itemprop="dateModified" datetime="2020-09-16T00:40:34+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<ul>
<li>代码还在本地，没commit</li>
<li>代码还在本地，已经commit，未push</li>
<li>代码还在本地，已经commit，已经push到远程仓库</li>
</ul>
<hr>
<h3 id="一、代码还在本地，没commit"><a href="#一、代码还在本地，没commit" class="headerlink" title="一、代码还在本地，没commit"></a>一、代码还在本地，没commit</h3><p>正常遇到这种场景，就是要切换到新的分支去commit代码了</p>
<h4 id="没有代码冲突"><a href="#没有代码冲突" class="headerlink" title="没有代码冲突"></a>没有代码冲突</h4><p>直接切换分支</p>
<h4 id="有代码冲突"><a href="#有代码冲突" class="headerlink" title="有代码冲突"></a>有代码冲突</h4><h6 id="操作流程"><a href="#操作流程" class="headerlink" title="[操作流程]"></a><strong>[操作流程]</strong></h6><ul>
<li>先将代码提交到<code>缓存区</code><br><code>git stash save</code></li>
<li>切换到新分支<br><code>git checkout [-b] &lt;branchName&gt;</code></li>
<li>将代码从<code>缓存区</code>取出<br><code>git stash apply</code></li>
</ul>
<p><code>[注意]</code> 取出之后可能有冲突，记得解决，不要直接commit了</p>
<p><code>git stash</code>也可以支持保存多次，只需要在后面加上message<code>git stash save -m &lt;message&gt;</code></p>
<p>要具体取出时，可以用可以用<code>git stash list</code>, 查看要取出哪一个缓存<br><img src="/images/git-error-code/1.png"><br>然后用<code>git stash apply stash@&#123;n&#125;</code>来取出</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2020/07/12/mkcert%E5%92%8Cbrowser-sync%E6%90%AD%E5%BB%BAhttps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/12/mkcert%E5%92%8Cbrowser-sync%E6%90%AD%E5%BB%BAhttps/" class="post-title-link" itemprop="url">mkcert和browser-sync搭建https</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-12 23:32:24" itemprop="dateCreated datePublished" datetime="2020-07-12T23:32:24+08:00">2020-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-13 00:07:41" itemprop="dateModified" datetime="2020-07-13T00:07:41+08:00">2020-07-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>随着https的普及，未来越来越多的应用会使用https，浏览器也越来越多让一些的功能只能在https下运行(摄像头、http的网络请求等)。所以为了开发、测试时候能模拟最真实的环境，我们也应当学会如何使用https。</p>
<p>今天就用<code>mkcert</code>，给大家介绍下如何创建一个本地受信任的ssl证书。<code>mkcert</code>几乎屏蔽所有的证书的创建流程，只需输入需要创建的domain。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote>
<p>通过brew来安装mkcert</p>
</blockquote>
<p>MacOS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mkcert</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本地信任mkcert</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkcert -install</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建证书</p>
</blockquote>
<p>我们创建一个同时支持localhost和<a target="_blank" rel="noopener" href="http://www.haha.com的证书/">www.haha.com的证书</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkcert localhost www.haha.com</span><br></pre></td></tr></table></figure>

<p>运行这个命令你就会得到两份文件<code>localhost+1.pem</code>和<code>localhost+1-key.pem</code>两份文件，接下来只需要在https的服务中添加这两个证书即可。</p>
<h1 id="创建https服务"><a href="#创建https服务" class="headerlink" title="创建https服务"></a>创建https服务</h1><p>下面分别原生https和browser-sync来创建https服务器</p>
<blockquote>
<p>原生https</p>
</blockquote>
<p>创建<code>https-server.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">&quot;https&quot;</span>);</span><br><span class="line"><span class="comment">// const https = require(&quot;http&quot;);</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  <span class="attr">key</span>: fs.readFileSync(<span class="string">&quot;localhost+1-key.pem&quot;</span>),</span><br><span class="line">  <span class="attr">cert</span>: fs.readFileSync(<span class="string">&quot;localhost+1.pem&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">https</span><br><span class="line">  .createServer(options, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req);</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .listen(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>最后运行<code>node ./https-server.js</code></p>
<blockquote>
<p>browser-sync</p>
</blockquote>
<p>使用browser-sync了话，我们需要在目录下创建一个index.html文件，内容如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  hello world</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建<code>start-browser.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browserSync = <span class="built_in">require</span>(<span class="string">&#x27;browser-sync&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line">browserSync(&#123;</span><br><span class="line">  <span class="attr">server</span>: <span class="string">&quot;./&quot;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;qwer.com&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8000</span>,</span><br><span class="line">  <span class="attr">https</span>: &#123;</span><br><span class="line">      <span class="attr">key</span>: path.resolve(__dirname, <span class="string">&quot;./localhost+1-key.pem&quot;</span>),</span><br><span class="line">      <span class="attr">cert</span>: path.resolve(__dirname, <span class="string">&quot;./localhost+1.pem&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后运行<code>node ./start-browser.js</code></p>
<p>来我们分别访问下<code>https://localhost:8080</code>和<code>https://qwer.com:8080</code>。得到的结果如下：</p>
<p><img src="https://pic2.zhimg.com/v2-212a01daea6bdb106d4f991ebe4b03c9_b.png"><br><img src="https://pic2.zhimg.com/v2-6755ca1b517ed36db5f9171020335fc9_b.png"></p>
<p>自此https服务器创建完成</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2018/08/13/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/13/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E7%AF%87/" class="post-title-link" itemprop="url">前端开发文档篇</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-13 13:23:16" itemprop="dateCreated datePublished" datetime="2018-08-13T13:23:16+08:00">2018-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-20 11:10:07" itemprop="dateModified" datetime="2020-06-20T11:10:07+08:00">2020-06-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="为什么需要开发文"><a href="#为什么需要开发文" class="headerlink" title="为什么需要开发文"></a>为什么需要开发文</h2><p>之所以, 花时间写开发文档主要是希望下一个接手的人, 可以通过阅读文档快速知道项目的进度。特别是对于一些大型的项目, 如果只是靠人之间口口相传, 容易导致项目交接的遗漏和一些bug永远的存在。</p>
<h2 id="前端文档内容"><a href="#前端文档内容" class="headerlink" title="前端文档内容"></a>前端文档内容</h2><p>根据, 现在前端的发展情况, 我大概整理下, 前端开发文档中应该包含的内容。</p>
<p><strong>前端文档目录:</strong></p>
<ol>
<li>摘要</li>
<li>背景</li>
<li>目标</li>
<li>里程碑</li>
<li>关键技术</li>
<li>开发流程</li>
<li>组件</li>
<li>页面说明</li>
<li>讨论(TODO)</li>
</ol>
<h4 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h4><p>摘要可以帮助公司的每位工程师理解文档的内容，并决定是否需要继续阅读文档的剩余部分。摘要最多可以包含 3 段内容。</p>
<h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>描述要解决什么问题、为什么需要这个项目、人们需要哪些知识才可以评估这个项目，以及它与技术战略、产品战略或团队的季度目标之间的关系。</p>
<h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><p>目标部分应该包括：</p>
<ol>
<li>描述项目对用户的影响——你的用户可能是另一个工程团队或另一个系统。</li>
<li>指定如何使用指标来度量项目的成功——如果可以链接到指标仪表盘那就更好了。</li>
</ol>
<h4 id="里程碑"><a href="#里程碑" class="headerlink" title="里程碑"></a>里程碑</h4><p>一系列可衡量的检查点，你的 PM 和上司可以借助它们大致了解项目的每个部分将在什么时间完成。如果项目时间超过 1 个月，我建议你将项目分解为面向用户的里程碑。<br>在设定里程碑时可以使用日历日期，把延期、假期、会议等因素都考虑进去。例如：</p>
<p>开始日期：2018 年 6 月 7 日</p>
<p>里程碑 1——以暗模式运行新系统 MVP：2018 年 6 月 28 日</p>
<p>里程碑 2——弃用旧系统：2018 年 7 月 4 日</p>
<p>结束日期：在新系统中添加新特性 X、Y、Z：2018 年 7 月 14 日</p>
<p>如果其中一些里程碑的 ETA 发生变化，需要在此处添加 [更新]，相关人员可以很容易看到更新的内容。</p>
<h4 id="关键技术"><a href="#关键技术" class="headerlink" title="关键技术"></a>关键技术</h4><p>关键技术主要应该说明如果要开发这个项目, 需要了解的技术, 以及这些技术在项目中的使用情况, 和对于一些重要函数和文件的说明, 让人可以对这个项目的主要技术有一定了解。</p>
<h4 id="开发流程"><a href="#开发流程" class="headerlink" title="开发流程"></a>开发流程</h4><p>在了解完技术后, 开发人员可能就会开始开发, 所以对整个的开发流程, 这里也要说明, 从<code>开发</code>到<code>发布</code>中的<code>注意事项</code>都应该在这里体现出来。</p>
<h4 id="通用组件和函数"><a href="#通用组件和函数" class="headerlink" title="通用组件和函数"></a>通用组件和函数</h4><p>由于近些年前端组件化、函数式的开发, 导致前端一定会有大量的通用组件和函数, 对于这些内容当完成后应该配有使用说明, 描述其中的属性、方法和示例等内容, 方便后续的人员使用, 如果对于一些未来可能需要扩展的组件, 也要予以说明。</p>
<h4 id="页面说明"><a href="#页面说明" class="headerlink" title="页面说明"></a>页面说明</h4><p>这部分并不是一定要每个页面都完成, 我个人认为只要对那些相对复杂的页面给予说明即可。</p>
<p>我认为要说明的内容有, 整个页面的开发思路、TODO等之类的内容, 一方面可以方便别人, 理解开发思路和未来的开发目标。</p>
<h4 id="讨论-TODO"><a href="#讨论-TODO" class="headerlink" title="讨论(TODO)"></a>讨论(TODO)</h4><p>在项目开发过程中, 必然存在一些有争议的内容, 对于这些个内容我觉得可以适当记录下来, 主要方便后期的回忆。但是不要什么都写, 主要应该是些重要的争议需求才记录。</p>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/FUZQRIRJE8IKbknrdBhLkw">如何才能写出好的软件设计文档？这里有一套方法论</a><br><a target="_blank" rel="noopener" href="https://www.wikihow.com/Write-Software-Documentation#">How to Write Software Documentation</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2018/05/06/js%E5%92%8Cts%E4%B8%AD%E7%9A%84decorator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/06/js%E5%92%8Cts%E4%B8%AD%E7%9A%84decorator/" class="post-title-link" itemprop="url">js和ts中的decorator</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-05-06 19:20:26 / 修改时间：22:05:51" itemprop="dateCreated datePublished" datetime="2018-05-06T19:20:26+08:00">2018-05-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前一段时间看了下，js中的装饰器，感觉未来这项语法会有许多的前景。所以这里来说说2个方面:</p>
<ol>
<li>怎么在js/ts中使用装饰器。</li>
<li>装饰器的常见用法(发射日志、类型验证、类添加属性等)。</li>
</ol>
<p>在开始前, 有一点值得说明下, 装饰器的生成都是编译的时候, 而不是运行的时候, 所以<code>this</code>这些可能对装饰器无法使用了。</p>
<h4 id="js中使用装饰器"><a href="#js中使用装饰器" class="headerlink" title="js中使用装饰器"></a>js中使用装饰器</h4><p>如果想在js中使用装饰器就必须使用babel, 需要添加”transform-decorators-legacy”插件, 配置如下:</p>
<p>项目中<code>npm i babel-plugin-transform-decorators-legacy</code>。</p>
<p>.babelrc配置修改如下.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugins: [&quot;transform-decorators-legacy&quot;] </span><br></pre></td></tr></table></figure>

<h4 id="ts中使用装饰器"><a href="#ts中使用装饰器" class="headerlink" title="ts中使用装饰器"></a>ts中使用装饰器</h4><p>在ts中使用装饰器就比较简单, 只要在<code>tsconfig.json</code>中添加一个配置就可以了:</p>
<p><code>tsconfig.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常见用法"><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h4><p>现在装饰器一般一共有四种用法, js只支撑2种, ts都支撑, 他们分别是:</p>
<ol>
<li>对<code>类</code>的修饰(js、ts)</li>
<li>对<code>方法</code>的修饰(js、ts)</li>
<li>对<code>属性</code>访问的修饰(ts)</li>
<li>对<code>参数</code>的修饰(ts)</li>
</ol>
<p>下面分别说说有哪些常见的用法。<br>对<code>类</code>修饰中, 可以给<code>类</code>额外添加一些属性或者方法, 比如在<a target="_blank" rel="noopener" href="https://angular.io/guide/displaying-data">angular</a>中就有这样子的用法, 有兴趣的朋友可以去看看angular使用方法。</p>
<p>在对<code>类</code>的装饰器中, 我们可以给类加一些属性或者方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">    target.type = <span class="string">&quot;It&#x27;s a component&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRender</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  target.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;i&#x27;m render&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@addRender</span><br><span class="line">@Component(&#123;</span><br><span class="line">  <span class="attr">select</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestCom</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在对<code>方法</code>的装饰器中, 我们修改方法的, 让它执行之前或者之后触发一些操作。</p>
<p>// 比如我们有一个loading函数, 那么我们就可以这么使用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loading</span>(<span class="params">target, keyname, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> oldFn = props.value;</span><br><span class="line">  props.value = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;start loading&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> oldFn.apply(<span class="built_in">this</span>, args).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// loadService.endLoading();</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;end loading&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  @loading</span><br><span class="line">  <span class="function"><span class="title">doAsyncAction</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> <span class="built_in">setTimeout</span>(res, <span class="number">1000</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在对<code>属性</code>访问的装饰器中, 属性访问这一层, js可以直接使用<code>Object.defineProperty</code>来设置, ts中允许直接设置属性, 所以这里我就写谢ts的用法。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readPrototype</span>(<span class="params">target, keyname, props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// console.log(target, keyname, props);</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`read: `</span>, keyname);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AB</span> </span>&#123;</span><br><span class="line">  <span class="meta">@readPrototype</span> <span class="keyword">get</span> <span class="title">a</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = <span class="keyword">new</span> AB();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(b.a);</span><br></pre></td></tr></table></figure>

<p>在对<code>参数</code>中, 我们可以借助装饰器进行些类型的验证。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isString</span>(<span class="params">target, keyname,index</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// console.log(args);</span></span><br><span class="line">  target[<span class="string">`__type_check__`</span>] = [<span class="string">`<span class="subst">$&#123;index&#125;</span>:string`</span>];</span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checker</span>(<span class="params">target, keyname, props</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(target, keyname, props)</span><br><span class="line">  <span class="keyword">let</span> oldValue = props.value;</span><br><span class="line">  props.value = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target[<span class="string">`__type_check__`</span>] &amp;&amp; target[<span class="string">`__type_check__`</span>].length) &#123;</span><br><span class="line">      target[<span class="string">`__type_check__`</span>].forEach(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> [i, <span class="keyword">type</span>] = e.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (args[i] !== <span class="keyword">type</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`<span class="subst">$&#123;keyname&#125;</span> must <span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> firstItem = args[<span class="number">0</span>];</span><br><span class="line">    oldValue.apply(<span class="built_in">this</span>, args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@checker</span></span><br><span class="line">  <span class="function"><span class="title">abc</span>(<span class="params"><span class="meta">@isString</span> txt</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`abc`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ha = <span class="keyword">new</span> C();</span><br><span class="line"></span><br><span class="line">ha.abc(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2018/04/27/TCO%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/27/TCO%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">TCO优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-27 17:10:54" itemprop="dateCreated datePublished" datetime="2018-04-27T17:10:54+08:00">2018-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-06-29 00:08:23" itemprop="dateModified" datetime="2018-06-29T00:08:23+08:00">2018-06-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这两天看下TCO做了下整理，参考的文章有:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000004018047">JS的递归与TCO尾调用优化</a></li>
<li><a target="_blank" rel="noopener" href="https://taylodl.wordpress.com/2013/06/07/functional-javascript-tail-call-optimization-and-trampolines/">Functional JavaScript – Tail Call Optimization and Trampolines</a></li>
</ol>
<p>js里面之所以需要TCO的原因是因为，大多数浏览器没有TCO做优化，所以导致在运行递归时，会为每次递归开辟一个”栈”来存储数据。但是这种方式很快就会超出最大”栈”限制，导致”栈溢出”问题，<span style="color: red"><code>Uncaught RangeError: Maximum call stack size exceeded</code></span>。</p>
<p>各个平台浏览器最大栈</p>
<table>
<thead>
<tr>
<th align="left">浏览器</th>
<th align="center">macos</th>
<th align="left">win</th>
</tr>
</thead>
<tbody><tr>
<td align="left">chrome</td>
<td align="center">8967(15695)</td>
<td align="left">11448</td>
</tr>
<tr>
<td align="left">firefox</td>
<td align="center">109152</td>
<td align="left">18946</td>
</tr>
<tr>
<td align="left">safari</td>
<td align="center">28187</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">edge</td>
<td align="center"></td>
<td align="left">16843</td>
</tr>
<tr>
<td align="left">ie</td>
<td align="center"></td>
<td align="left">6205</td>
</tr>
</tbody></table>
<p>比如上述文章中阶乘的例子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n * factorial(n-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在数量少的时候没啥问题<code>factorial(10)</code>， 但是一旦数量太大就会立马抛出溢出错误<code>factorial(1000000)</code>。<br>打开chrome性能分析工具可以看到，当第一次运行了函数<code>factorial</code>后会一直调用<code>factorial</code>。</p>
<p><img src="/images/tco/performance.png"></p>
<p>第一步先改写方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">recur</span>(<span class="params">n, acc</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> acc;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> recur(n-<span class="number">1</span>, n*acc);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> recur(n, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="优化方法"><a href="#优化方法" class="headerlink" title="优化方法"></a>优化方法</h2><p>其实, 唯一的解法就是<code>复用栈</code>, 但是实现的方式可以是多种多样.</p>
<p>根据上面文章的提示，总结下大概有以下几种方法。</p>
<h4 id="1-改用循环"><a href="#1-改用循环" class="headerlink" title="1.改用循环"></a>1.改用循环</h4><p>一种修改最大，但是最简单的就是把递归改循环。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> acc = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(n) &#123;</span><br><span class="line">        acc *= n;</span><br><span class="line">        n--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> acc = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=n; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        acc *= i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本上所有的递归函数都可以改成轮询，但是缺点就是可能因此代码的逻辑性变差。</p>
<h4 id="2-babel-有TCO优化的引擎"><a href="#2-babel-有TCO优化的引擎" class="headerlink" title="2.babel || 有TCO优化的引擎"></a>2.babel || 有TCO优化的引擎</h4><p>在有TCO优化引擎或者babel中我们可以这么优化上诉的逻辑。<br>babel可以使用<code>babel-plugin-tailcall-optimization</code>插件进行转化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">recur</span>(<span class="params">n, acc</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> acc;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> recur(n-<span class="number">1</span>, n*acc);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> recur(n, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将递归放入到函数内部。</p>
<blockquote>
<p>注意: 这个操作只能, 对单个递归函数进行分析, 如果是多个函数相互嵌套就无法使用。</p>
</blockquote>
<h4 id="3-trampoline-蹦床-函数"><a href="#3-trampoline-蹦床-函数" class="headerlink" title="3.trampoline(蹦床) 函数"></a>3.trampoline(蹦床) 函数</h4><p>第三种方法就是利用trampoline 函数，相对循环方法，只需要修改一小部分的代码就可以完成同样的效果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trampoline</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (f &amp;&amp; f <span class="keyword">instanceof</span> <span class="built_in">Function</span>) &#123;</span><br><span class="line">        f = f();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上述的<code>factorial</code>改成如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">recur</span>(<span class="params">n, acc</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> recur.bind(<span class="literal">null</span>, n-<span class="number">1</span>, n*acc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> trampoline(recur.bind(<span class="literal">null</span>, n, <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需要将<code>return</code>的函数加上<code>bind</code>，并在最外层返回是加上<code>trampoline</code>就算是修改完成。<br>简单说就是<code>trampoline</code>函数放入到循环中不停的接收、执行函数。</p>
<p>此外，第一篇文章还给出了trampoline一个种优化函数，修改的代码更少。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tco</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> accumulated = [];</span><br><span class="line">    <span class="keyword">let</span> active = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">accumulator</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      </span><br><span class="line">        accumulated.push(args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!active) &#123;</span><br><span class="line">            active = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (accumulated.length) &#123;</span><br><span class="line">                value = f.apply(<span class="built_in">this</span>, accumulated.shift());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            active = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>递归代码修改成如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> factorial = tco(<span class="function">(<span class="params">n, acc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> acc;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> factorial(n - <span class="number">1</span>, n * acc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">factorial(<span class="number">10</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2018/04/26/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AC%94%E8%AF%95%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/26/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AC%94%E8%AF%95%E9%A2%98/" class="post-title-link" itemprop="url">记一次笔试题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-04-26 20:00:13 / 修改时间：20:17:27" itemprop="dateCreated datePublished" datetime="2018-04-26T20:00:13+08:00">2018-04-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前，参加阿里的笔试题。题目如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//题目1:</span><br><span class="line">//字符串数组去除重复的项，即[‘1’,‘2’,‘1’,‘3’]——&gt;[‘1’,‘2’,‘3’]</span><br><span class="line"></span><br><span class="line">//题目2:</span><br><span class="line">//写个转换函数，把一个JSON对象的key从横杠形式（Pascal）转换到小驼峰形式（Camel），即&#123;“a_b”:1&#125;——&gt;&#123;“aB”:1&#125;</span><br><span class="line"></span><br><span class="line">//题目3:</span><br><span class="line">//写一个类Person，拥有属性age和name，拥有方法say(something)</span><br><span class="line">//再写一个类Superman，继承Person，拥有自己的属性power，拥有自己的方法fly(height)</span><br></pre></td></tr></table></figure>

<h3 id="第一题"><a href="#第一题" class="headerlink" title="第一题"></a>第一题</h3><p>就是正常利用set和spread(…)语法就可以完成:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;3&#x27;</span>];</span><br><span class="line"><span class="keyword">let</span> newArr = [...new <span class="built_in">Set</span>(arr)];</span><br></pre></td></tr></table></figure>
<p>如果是es5的话，可以判断新数组有没有这个元素，来去重。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newArr1 = [];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!(newArr1.indexOf(arr[i]) &gt; -<span class="number">1</span>)) &#123;</span><br><span class="line">		newArr1.push(arr[i]);	</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第二题"><a href="#第二题" class="headerlink" title="第二题"></a>第二题</h3><p>我觉得更好的方法还是根据”<em>“来拆分，然后从第二项开始的元素进行首字母大写，但是当时对首字母大写这个没啥好想法。<br>所以就直接拆解了键值，判断前一个是不是”</em>“。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sourceObj = &#123;<span class="string">&quot;a_b&quot;</span>:<span class="number">1</span>, <span class="string">&quot;a_ca&quot;</span>: <span class="number">2</span>&#125;;</span><br><span class="line"><span class="built_in">Object</span>.keys(sourceObj).reduce(<span class="function">(<span class="params">obj, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> newKey = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      </span><br><span class="line">    key.split(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      .forEach(<span class="function">(<span class="params">frag, i, arr</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (frag !== <span class="string">&quot;_&quot;</span>) &#123;</span><br><span class="line">          newKey += <span class="string">`<span class="subst">$&#123;arr[i - <span class="number">1</span>] === <span class="string">&quot;_&quot;</span> ? frag.toUpperCase() : frag&#125;</span><span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(obj, &#123;[newKey]: sourceObj[key]&#125;);</span><br><span class="line">&#125;, &#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>后来笔试结束后，我查了下几种首字母大写的方法。分享下:</p>
<p>第一种利用String的静态方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upcase1</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> key.chatAt(<span class="number">0</span>).toUpperCase() + key.slice(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upcase2</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> key.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + key.substring(<span class="number">1</span>, a.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二种利用正则的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upcase3</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> key.replace(<span class="regexp">/\w/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params">text, i</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> text.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> text;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上诉的3种方法都可以实现首字母大写。</p>
<h3 id="第三题"><a href="#第三题" class="headerlink" title="第三题"></a>第三题</h3><p>简单的oop编程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">name, age</span>)</span> &#123;</span><br><span class="line">      	<span class="built_in">this</span>.name = name;</span><br><span class="line">		<span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="title">say</span>(<span class="params">something</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;say: &quot;</span>, something);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Superman</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">name, age, power</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(name, age);</span><br><span class="line">    	<span class="built_in">this</span>.power = power;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="title">fly</span>(<span class="params">height</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;fly: &quot;</span>, height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是es5, 代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span> (<span class="params">name, age</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.name = name;</span><br><span class="line">  <span class="built_in">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.say = <span class="function"><span class="keyword">function</span>(<span class="params">something</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;say: &quot;</span>, something);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Superman</span>(<span class="params">name, age, power</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.power = power;</span><br><span class="line">  </span><br><span class="line">  Person.call(<span class="built_in">this</span>, name, age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Superman.prototype = Person.prototype;</span><br><span class="line"></span><br><span class="line">Superman.prototype.fly = <span class="function"><span class="keyword">function</span>(<span class="params">height</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;fly: &quot;</span>, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大致的题目和解法就是这些。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2018/04/11/Dom%E6%98%AF%E5%90%A6%E5%8F%AF%E8%A7%81%E7%9B%91%E5%90%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/11/Dom%E6%98%AF%E5%90%A6%E5%8F%AF%E8%A7%81%E7%9B%91%E5%90%AC/" class="post-title-link" itemprop="url">Dom是否可见监听</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-11 21:43:38" itemprop="dateCreated datePublished" datetime="2018-04-11T21:43:38+08:00">2018-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-04-14 04:33:44" itemprop="dateModified" datetime="2018-04-14T04:33:44+08:00">2018-04-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在页面性能优化里面, 现在普遍开始提倡, 当页面滚动到某个图片元素时开始加载那个图片。所以, 今天来探讨下有几种实现方式。</p>
<p>假设我们有这样子的dom</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">  <span class="selector-tag">body</span>, <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">    <span class="attribute">height</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">  &#125;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">img</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="css">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="css">  &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;content-1&quot;</span> <span class="attr">data-src</span>=<span class="string">&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1523470404210&amp;di=9e0756eff787371b297db5f8741d4b32&amp;imgtype=0&amp;src=http%3A%2F%2Fimgsrc.baidu.com%2Fimgad%2Fpic%2Fitem%2F8b82b9014a90f6037cb445933312b31bb151edda.jpg&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;content-2&quot;</span> <span class="attr">data-src</span>=<span class="string">&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1523470404210&amp;di=e8b9b2b30df3fe6d856f4c3e19a6d420&amp;imgtype=0&amp;src=http%3A%2F%2Fpic15.nipic.com%2F20110803%2F7180732_211822337168_2.jpg&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;content-3&quot;</span> <span class="attr">data-src</span>=<span class="string">&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1523470462666&amp;di=97f0de7b723fd2d40e6bde945d6073c0&amp;imgtype=0&amp;src=http%3A%2F%2Fimgsrc.baidu.com%2Fimage%2Fc0%253Dpixel_huitu%252C0%252C0%252C294%252C40%2Fsign%3Dc690ddf3edcd7b89fd6132c3665c27cb%2F8b82b9014a90f603611a417e3212b31bb051ed65.jpg&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>IntersectionObserver API</li>
</ol>
<p>IntersectionObserver 是一个可以监听DOM是否在视口的API。官方给出的解释如下:</p>
<blockquote>
<p>Intersection observer 允许你配置一个回调函数，每当target,元素和设备视口或者其他指定元素发生交集的时候该回调函数将会被执行。设备视口或者其他元素我们称它为root element 或者 root。特别是你想要监听(target)元素相对于浏览器视口(root)的交集变化的时候(intersection API初始化的时候 如果设置root参数为null或者不设置则root默认为设备视口)。无论你是使用viewport或者其他element做为root， intersection API都会以相同方式工作，每当tartget element在root 中的可见性交集数量发生变化(target元素的位置在root中发生变化)都会执行你提供的回调函数</p>
</blockquote>
<p>总结下, 就是当你滚动到root元素使监听的元素可见时, 就会触发回调函数。</p>
<p>所以代码就如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> IntersectionObserver(<span class="function">(<span class="params">images</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`我是回调函数`</span>, images);</span><br><span class="line">  images.forEach(<span class="function"><span class="params">image</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (image.intersectionRatio &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123;target&#125; = image;</span><br><span class="line">      target.src = target.dataset.src;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">Array</span>.from(<span class="built_in">document</span>.querySelectorAll(<span class="string">&quot;img&quot;</span>)).forEach(<span class="function">(<span class="params">e</span>) =&gt;</span> observer.observe(e))</span><br></pre></td></tr></table></figure>

<p>执行后, 控制台立马就会输出<code>[IntersectionObserverEntry]</code>对象数组, 以判断dom是不是在视口中。IntersectionObserver会分别会在dom离开和进入视口时执行回调, 所以我们必须利用<code>intersectionRatio</code>来判断dom是否在视口中。<code>intersectionRatio</code>表示目标元素与视口的交叉区域的百分比。</p>
<ol start="2">
<li>用scroll事件来监听</li>
</ol>
<p>scroll 事件我就不多做介绍了。用scroll的原理就是利用getBoundingClientRect获取dom在页面中位置, 然后判断跟边界的上下左右距离是否在视口中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> images = <span class="built_in">document</span>.querySelectorAll(<span class="string">&quot;img&quot;</span>);</span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&quot;scroll&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  showImage();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">showImage();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showImage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  images.forEach(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isInView(e, <span class="built_in">document</span>.documentElement)) &#123;</span><br><span class="line">      e.src = e.dataset.src</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过元素到边框的距离与页面滚动的高度来判断是否已经显示了元素</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isInView</span>(<span class="params">el, root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> bounding = el.getBoundingClientRect();</span><br><span class="line">  <span class="keyword">return</span> (bounding.top - (root.clientHeight + root.scrollTop)) &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">         (bounding.left - (root.clientWidth + root.scrollLeft)) &lt; <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着做点节流的优化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> images = <span class="built_in">document</span>.querySelectorAll(<span class="string">&quot;img&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> scrollFn = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> timeout = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">time = <span class="number">50</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    timeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      showImage();</span><br><span class="line">    &#125;, time);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&quot;scroll&quot;</span>, scrollFn)</span><br><span class="line"></span><br><span class="line">showImage();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showImage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  images.forEach(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isInView(e, <span class="built_in">document</span>.documentElement)) &#123;</span><br><span class="line">      e.src = e.dataset.src</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过元素到边框的距离与页面滚动的高度来判断是否已经显示了元素</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isInView</span>(<span class="params">el, root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> bounding = el.getBoundingClientRect();</span><br><span class="line">  <span class="keyword">return</span> (bounding.top - (root.clientHeight + root.scrollTop)) &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">         (bounding.left - (root.clientWidth + root.scrollLeft)) &lt; <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是我今天总结的2种显示滚动加载图片的方式。如果你需要配合framework使用可以将scroll的函数封装成一个服务, 这样子就只需要一个监听函数。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2018/03/29/%E5%88%A9%E7%94%A8ae%E5%8A%A8%E7%94%BB%E5%B5%8C%E5%85%A5web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/29/%E5%88%A9%E7%94%A8ae%E5%8A%A8%E7%94%BB%E5%B5%8C%E5%85%A5web/" class="post-title-link" itemprop="url">利用ae动画嵌入web</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-03-29 12:18:03 / 修改时间：15:40:54" itemprop="dateCreated datePublished" datetime="2018-03-29T12:18:03+08:00">2018-03-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近跟群友讨论下怎么在Web上实现酷炫动画。比如<br><img src="/images/ae-1.gif"></p>
<p><img src="/images/ae-2.gif"></p>
<p>我之前能想到的方法就是直接利用video标签嵌入页面、或者直接用D3这些第三方库手写动画。但是朋友告诉我利用bodymovin.js将ae的动画倒入到web中, 看到这个所以打算来试试AE。</p>
<p>于是我做了一个非常简单的ae动画, 将一个块从左边移动右边(<a href="/images/ae-3.mov">效果</a>)。然后在<a target="_blank" rel="noopener" href="https://github.com/airbnb/lottie-web/">lottie-web</a>中找到ae的bodymovin插件并安装, 安装自然可以再插件中进行渲染动画。输入的文件会是一个<a href="/images/ae-4.json">json</a>文件。</p>
<p>在效果有效果文件, 新建一个web, 然后引入bodymovin.js, 并且利用bodymovin对象导入动画。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;animation&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/bodymovin/4.13.0/bodymovin.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    bodymovin.loadAnimation(&#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">path</span>:<span class="string">&#x27;data.json&#x27;</span>,   <span class="comment">//json文件路径</span></span></span><br><span class="line"><span class="javascript">            <span class="attr">loop</span>:<span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">autoplay</span>:<span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">renderer</span>:<span class="string">&#x27;canvas&#x27;</span>,  <span class="comment">//渲染方式，有&quot;html&quot;、&quot;canvas&quot;和&quot;svg&quot;三种</span></span></span><br><span class="line"><span class="javascript">            <span class="attr">container</span>:<span class="built_in">document</span>.getElementById(<span class="string">&#x27;animation&#x27;</span>)</span></span><br><span class="line"><span class="javascript">        &#125;);</span></span><br><span class="line"><span class="javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最终播放效果。<br><img src="/images/ae-5.gif"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://smallgress.github.io/2017/12/17/%E5%88%A9%E7%94%A8MediaRecorder%E5%81%9A%E7%9B%B4%E6%92%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SmallGress">
      <meta itemprop="description" content="记录学习js的历程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一片野草">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/12/17/%E5%88%A9%E7%94%A8MediaRecorder%E5%81%9A%E7%9B%B4%E6%92%AD/" class="post-title-link" itemprop="url">利用MediaRecorder做直播</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2017-12-17 10:28:26 / 修改时间：14:39:50" itemprop="dateCreated datePublished" datetime="2017-12-17T10:28:26+08:00">2017-12-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前段时间利用一些时间，学习了直播的内容，前端使用利用MediaRecorder做录屏，后端使用nginx+ffmpeg。<br>由于MediaRecorder的兼容性问题，这里使用[msr(<a target="_blank" rel="noopener" href="https://github.com/streamproc/MediaStreamRecorder)%E5%81%9A%E5%85%BC%E5%AE%B9%EF%BC%8C%E9%80%9A%E8%BF%87websocket%E5%B0%86%E8%A7%86%E9%A2%91%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81%E7%BB%99%E5%90%8E%E7%AB%AF%EF%BC%8C%E5%88%A9%E7%94%A8ffmpeg%E7%94%9F%E6%88%90ts%E6%96%87%E4%BB%B6%E8%BF%9B%E8%A1%8Chls%E7%9B%B4%E6%92%AD%E3%80%82">https://github.com/streamproc/MediaStreamRecorder)做兼容，通过websocket将视频数据发送给后端，利用ffmpeg生成ts文件进行hls直播。</a></p>
<p>前端通过msr来获取摄像头的图像转成blob对象发送给后端</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recorder</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    userId = uuidv4();</span><br><span class="line">    socket.emit(<span class="string">&quot;start_play&quot;</span>, userId);</span><br><span class="line"></span><br><span class="line">    navigator.mediaDevices.getUserMedia(mediaSource)</span><br><span class="line">        .then(getStream)</span><br><span class="line">        .catch(<span class="built_in">console</span>.error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStream</span>(<span class="params">stream: MediaStream</span>) </span>&#123;</span><br><span class="line">    devicesStream = stream;</span><br><span class="line">    video.srcObject = stream;</span><br><span class="line"></span><br><span class="line">    recorderObj = <span class="keyword">new</span> MediaStreamRecorder(stream);</span><br><span class="line"></span><br><span class="line">    recorderObj.mimeType = recordType;</span><br><span class="line">    recorderObj.ondataavailable = <span class="function"><span class="keyword">function</span> (<span class="params">blob: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">        socket.emit(recordEvent, &#123;</span><br><span class="line">            <span class="attr">id</span>: userId,</span><br><span class="line">            <span class="attr">data</span>: blob</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    recorderObj.start(recordTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端接收后，通过ffmpeg来生成需要直播的内容</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeUrl</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(__dirname, <span class="string">`./cache/<span class="subst">$&#123;file&#125;</span>.mp4`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">liveFile</span>(<span class="params">data, userId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> id = uuidv4();</span><br><span class="line">    <span class="keyword">let</span> url = makeUrl(id);</span><br><span class="line">    </span><br><span class="line">    writeFile(url, data, <span class="string">&quot;base64&quot;</span>)</span><br><span class="line">    .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        live(url, userId);</span><br><span class="line">        deleteFile(url);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">live</span>(<span class="params">url, id</span>) </span>&#123;</span><br><span class="line">    ffmpeg(url)</span><br><span class="line">    .duration(<span class="number">30</span>)</span><br><span class="line">    .videoCodec(<span class="string">&quot;libx264&quot;</span>)</span><br><span class="line">    .format(<span class="string">&quot;flv&quot;</span>)</span><br><span class="line">    .output(liveUrl(id))</span><br><span class="line">    .run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteFile</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        unlink(url)</span><br><span class="line">    &#125;, <span class="number">120000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目的地址<a target="_blank" rel="noopener" href="https://github.com/SmallGress/live">github</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">SmallGress</p>
  <div class="site-description" itemprop="description">记录学习js的历程</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SmallGress</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
